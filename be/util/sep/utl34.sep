/*
Copyright (c) 2008 Ingres Corporation

	Test Name: utl34.sep
	Time: Tue Apr 24 15:51:23 2001
	User Name: testenv
	Terminal type: septerm
 
	Test ID : utl34.sep
	Module  : be/util
	Filename: utl34.sep
	Purpose	: To test the new copydb flags for the maximum size 32K 
                  character data type columns, first available with II 2.6/0106
                  and later releases. And test maximum size of 16K for
                  character data types of c, char, text, and varchar for UTF8.
                  The maximum for long varchar is actually 2GB but that is not
                  practical for this SEP test, so the column lengths will be
                  32K (default) and 16K (UTF8) for long varchar.
	Input Files  : kopy32.sc
	Output Files : kopy32.exe
	Database     : utildb3, utildb4
	Tables       : utl34_table1, utl34_table2, utl34_table3, utl34_table4,
                       utl34_table5
	Synopsis     : This sep test is to test the 32K bytes per column for 
                       all character data types with copydb. The program is to 
                       create five tables in database utildb3. Then these
                       tables will be copied to database utildb4. 

 History: 24-Apr-2001	(wu$ca01) Created
          05-Jun-2001	(wu$ca01) Test will fail on NT platform for 
                        'long varchar' data type. See issue 10928220. Once the
                        issue is fixed, <<IF (NT_GENERIC)>> CANON can be remove.
          09-Aug-2001	(wu$ca01) Added commands to cleanup temporary test
                        files at the end. Clarified the Purpose text.
          11-Dec-2001	(wu$ca01) Issue 10928220 resolved, remove (NT_GENERIC)
                        CANON.
           8-May-2003	(wu$ca01) Updated test due to schema has changed (i.e.
                        'utl34_table1.tes' to 'utl34_table1.testenv'). Added
                        the drop statements to clean out the tables in the
                        database.
	  21-Oct-2008   (wanfr01) utildb3 should be SEPPARAMDB3
           4-Nov-2008   (vande02) The test program was changed to accept an
                        additional argument SEPPARAM_CHARSET and set the max
                        column size to 16K for UTF8 or 32K (default) for
                        non-UTF8.  Conditional canon for UTF8 was also created.
                        Removed the 'p' print SQL syntax.
*/
? fill kopy32.sc 
!!
/* This program is to create five tables, each with different character data 
** type for testing the copydb with the maximum size column of 32K bytes
** for a non-UTF8 instance and using maximum size columns of 16K bytes for UTF8.
*/

#include <stdio.h>
exec sql include sqlca;

#define MAXVCSZ 32000
#define MAXUTF8SZ 16000

main(int argc, char* argv[])
{
    exec sql begin declare section;
      char   *dbname;
	varchar struct {
	    short	buf_size;
	    char	buf[MAXVCSZ+1];
	} vch;

	varchar struct {
	    short	buf_size;
	    char	buf[MAXVCSZ+1];
	} vch2;
    int vcsz;
    char  *charset;
    char stmtbuff[256];
    exec sql end declare section;

    exec sql whenever sqlerror call sqlprint;

    dbname = argv[1];
    charset = argv[2];
    if (strcmp(charset, "UTF8") == 0)
      vcsz = MAXUTF8SZ;
    else
      vcsz = MAXVCSZ;

    exec sql connect :dbname;
    /* Ignore errors from drop table */
    exec sql whenever sqlerror continue;
    exec sql drop table utl34_table1;
    exec sql drop table utl34_table2;
    exec sql drop table utl34_table3;
    exec sql drop table utl34_table4;
    exec sql drop table utl34_table5;

    exec sql whenever sqlerror call sqlprint;
/* Create table utl34_table1. */
    sprintf(stmtbuff, "create table utl34_table1(col_c c(%d))", vcsz);
    exec sql execute immediate :stmtbuff;

    memset(vch.buf, 'a', vcsz);
    vch.buf_size = vcsz;
    memset(vch.buf+5, '@', 10);
    memset(vch.buf+vcsz-10, '!', 10);

    exec sql insert into utl34_table1 values (:vch);

    exec sql select col_c into :vch2 from utl34_table1;

    if (vch.buf_size == vch2.buf_size &&
	memcmp(vch.buf, vch2.buf, vcsz) == 0)
    {
        printf("Table utl34_table1 is successfully created!!!\n");
    }
    else
	printf("Failure!!!\n");

/* Create table utl34_table2. */
    sprintf(stmtbuff, "create table utl34_table2(col_char char(%d))", vcsz);
    exec sql execute immediate :stmtbuff;

    memset(vch.buf, '3', vcsz);
    vch.buf_size = vcsz;
    memset(vch.buf, '*', 10);
    memset(vch.buf+vcsz-10, '!', 10);

    exec sql insert into utl34_table2 values (:vch);

    exec sql select col_char into :vch2 from utl34_table2;

    if (vch.buf_size == vch2.buf_size &&
        memcmp(vch.buf, vch2.buf, vcsz) == 0)
    {
        printf("Table utl34_table2 is successfully created!!!\n");
    }
    else
        printf("Failure!!!\n");

/* Create table utl34_table3. */
    sprintf(stmtbuff, "create table utl34_table3(col_text text(%d))", vcsz);
    exec sql execute immediate :stmtbuff;

    memset(vch.buf, '@', vcsz);
    vch.buf_size = vcsz;
    memset(vch.buf, '?', 10);
    memset(vch.buf+vcsz-10, '#', 10);

    exec sql insert into utl34_table3 values (:vch);

    exec sql select col_text into :vch2 from utl34_table3;

    if (vch.buf_size == vch2.buf_size &&
        memcmp(vch.buf, vch2.buf, vcsz) == 0)
    {
        printf("Table utl34_table3 is successfully created!!!\n");
    }
    else
        printf("Failure!!!\n");

/* Create table utl34_table4. */
    sprintf(stmtbuff,"create table utl34_table4(col_varchar varchar(%d))",vcsz);
    exec sql execute immediate :stmtbuff;

    memset(vch.buf, 'q', vcsz);
    vch.buf_size = vcsz;
    memset(vch.buf, '$', 10);
    memset(vch.buf+vcsz-10, '?', 10);

    exec sql insert into utl34_table4 values (:vch);

    exec sql select col_varchar into :vch2 from utl34_table4;

    if (vch.buf_size == vch2.buf_size &&
        memcmp(vch.buf, vch2.buf, vcsz) == 0)
    {
        printf("Table utl34_table4 is successfully created!!!\n");
    }
    else
        printf("Failure!!!\n");

/* Create table utl34_table5. */
    exec sql create table utl34_table5(col_longvar long varchar);

    memset(vch.buf, 'z', vcsz);
    vch.buf_size = vcsz;
    memset(vch.buf, '9', 10);
    memset(vch.buf+vcsz-10, '0', 10);

    exec sql insert into utl34_table5 values (:vch);

    exec sql select col_longvar into :vch2 from utl34_table5;

    if (vch.buf_size == vch2.buf_size &&
        memcmp(vch.buf, vch2.buf, vcsz) == 0)
    {
        printf("Table utl34_table5 is successfully created!!!\n");
    }
    else
        printf("Failure!!!\n");

    exec sql disconnect;
}

!!
? esqlc kopy32.sc 
<<
~
>>
? sepcc kopy32 
<<
~
>>
? seplnk kopy32 
<<
~
>>
? run kopy32.exe SEPPARAMDB3 SEPPARAM_CHARSET
<<
Table utl34_table1 is successfully created!!!
Table utl34_table2 is successfully created!!!
Table utl34_table3 is successfully created!!!
Table utl34_table4 is successfully created!!!
Table utl34_table5 is successfully created!!!
>>
? copydb -add_drop -all -infile=kopy32.in -outfile=kopy32.out -noint SEPPARAMDB3
<<
~
>>
? sql -s SEPPARAMDB3 
<<

>>
* \i kopy32.out 
<<
~
>>
* \q 
<<

>>
? sql -s SEPPARAMDB4 
<<

>>
* \i kopy32.in
<<
~
>>
* select varchar(left(col_c,20),60) from utl34_table1\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|aaaaa@@@@@@@@@@aaaaa                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(right(col_c,20),60) from utl34_table1\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|aaaaaaaaaa!!!!!!!!!!                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(left(col_char,20),60) from utl34_table2\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|**********3333333333                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(right(col_char,20),60) from utl34_table2\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|3333333333!!!!!!!!!!                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(left(col_text,20),60) from utl34_table3\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|??????????@@@@@@@@@@                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(right(col_text,20),60) from utl34_table3\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|@@@@@@@@@@##########                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(left(col_varchar,20),60) from utl34_table4\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|$$$$$$$$$$qqqqqqqqqq                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(right(col_varchar,20),60) from utl34_table4\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|qqqqqqqqqq??????????                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(left(col_longvar,20),60) from utl34_table5\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|9999999999zzzzzzzzzz                                        |
+------------------------------------------------------------+
(1 row)
>>
* select varchar(right(col_longvar,20),60) from utl34_table5\g
<<

+------------------------------------------------------------+
|col1                                                        |
+------------------------------------------------------------+
|zzzzzzzzzz0000000000                                        |
+------------------------------------------------------------+
(1 row)
>>
* \q
<<
>>
? sql -s SEPPARAMDB3
<<

>>
* drop table utl34_table1\g
<<
>>
* drop table utl34_table2\g
<<
>>
* drop table utl34_table3\g
<<
>>
* drop table utl34_table4\g
<<
>>
* drop table utl34_table5\g
<<
>>
* \q
<<
>>
? delete kopy32.sc 
<<
~
>>
? delete kopy32.c 
<<
~
>>
? delete kopy32.o 
<<
~
>>
? delete kopy32.obj 
<<
~
>>
? delete kopy32.exe 
<<
~
>>
? delete kopy32.in
<<
~
>>
? delete kopy32.out
<<
~
>>
? delete utl34_table1.testenv
<<
~
>>
? delete utl34_table2.testenv
<<
~
>>
? delete utl34_table3.testenv
<<
~
>>
? delete utl34_table4.testenv
<<
~
>>
? delete utl34_table5.testenv
<<
~
>>


Ending at: Mon Jun 04 18:37:49 2001
